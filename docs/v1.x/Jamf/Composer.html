<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: Jamf::Composer
  
    &mdash; ruby-jss-1.3.3
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "Jamf::Composer";
  relpath = '../';
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../_index.html">Index (C)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../Jamf.html" title="Jamf (module)">Jamf</a></span></span>
     &raquo; 
    <span class="title">Composer</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Module: Jamf::Composer
  
  
  
</h1>
<div class="box_info">
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/jamf/composer.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>This module provides two methods for building very simple Casper-happy .pkg
and .dmg packages for deployment.</p>

<p>Unlike Composer.app from JAMF, this module currently doesn&#39;t offer a
way to do a before/after disk scan and use the differences to build the
root folder from which the package is built. Nor does the module support
editing the pre/post install scripts in .pkgs.</p>

<p>The &#39;root folder&#39;, a folder representing the root filesystem of the
target machine where the package will be installed, must already exist and
be fully populated and with correct permissions.</p>


  </div>
</div>
<div class="tags">
  

</div>
  
    <h2>
      Constant Summary
      <small><a href="#" class="constants_summary_toggle">collapse</a></small>
    </h2>

    <dl class="constants">
      
        <dt id="PKG_UTIL-constant" class="">PKG_UTIL =
          <div class="docstring">
  <div class="discussion">
    
<p>the apple pkgutil tool</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='const'><span class='object_link'><a href="../Pathname.html" title="Pathname (class)">Pathname</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/usr/sbin/pkgutil</span><span class='tstring_end'>&#39;</span></span></pre></dd>
      
        <dt id="PKGBUILD-constant" class="">PKGBUILD =
          <div class="docstring">
  <div class="discussion">
    
<p>The location of the cli tool for making .pkgs</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='const'><span class='object_link'><a href="../Pathname.html" title="Pathname (class)">Pathname</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/usr/bin/pkgbuild</span><span class='tstring_end'>&#39;</span></span></pre></dd>
      
        <dt id="PKG_BUNDLE_ID_PFX-constant" class="">PKG_BUNDLE_ID_PFX =
          <div class="docstring">
  <div class="discussion">
    
<p>the default bundle identifier prefix for pkgs</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ruby-jss-composer</span><span class='tstring_end'>&#39;</span></span><span class='period'>.</span><span class='id identifier rubyid_freeze'>freeze</span></pre></dd>
      
        <dt id="HDI_UTIL-constant" class="">HDI_UTIL =
          <div class="docstring">
  <div class="discussion">
    
<p>Apple&#39;s hdiutil for making dmgs</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/usr/bin/hdiutil</span><span class='tstring_end'>&#39;</span></span><span class='period'>.</span><span class='id identifier rubyid_freeze'>freeze</span></pre></dd>
      
        <dt id="DEFAULT_OUT_DIR-constant" class="">DEFAULT_OUT_DIR =
          <div class="docstring">
  <div class="discussion">
    
<p>Where to save the output ?</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='const'><span class='object_link'><a href="../Pathname.html" title="Pathname (class)">Pathname</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/Users/Shared</span><span class='tstring_end'>&#39;</span></span></pre></dd>
      
    </dl>
  







  
    <h2>
      Class Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#mk_dmg-class_method" title="mk_dmg (class method)">.<strong>mk_dmg</strong>(name, root, out_dir = DEFAULT_OUT_DIR)  &#x21d2; Pathname </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Make a casper-happy .dmg out of a root folder, permissions are assumed to
be correct.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#mk_pkg-class_method" title="mk_pkg (class method)">.<strong>mk_pkg</strong>(name, version, root, opts = {})  &#x21d2; Pathname </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Make a casper-happy .pkg out of a root folder, permissions are assumed to
be correct.</p>
</div></span>
  
</li>

      
    </ul>
  



  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="mk_dmg-class_method">
  
    .<strong>mk_dmg</strong>(name, root, out_dir = DEFAULT_OUT_DIR)  &#x21d2; <tt><span class='object_link'><a href="../Pathname.html" title="Pathname (class)">Pathname</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Make a casper-happy .dmg out of a root folder, permissions are assumed to
be correct.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>name</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../String.html" title="String (class)">String</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The name of the .dmg, the suffix will be added if needed</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>root</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../String.html" title="String (class)">String</a></span></tt>, <tt><span class='object_link'><a href="../Pathname.html" title="Pathname (class)">Pathname</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the path to the “root folder” representing the root file system of the
target install drive</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>out_dir</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../String.html" title="String (class)">String</a></span></tt>, <tt><span class='object_link'><a href="../Pathname.html" title="Pathname (class)">Pathname</a></span></tt>)</span>
      
      
        <em class="default">(defaults to: <tt>DEFAULT_OUT_DIR</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>the folder in which the .pkg will be created. Defaults to <span class='object_link'><a href="#DEFAULT_OUT_DIR-constant" title="Jamf::Composer::DEFAULT_OUT_DIR (constant)">DEFAULT_OUT_DIR</a></span></p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Pathname.html" title="Pathname (class)">Pathname</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the local path to the new .dmg</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


172
173
174
175
176
177
178
179
180
181
182
183
184
185
186</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/jamf/composer.rb', line 172</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_mk_dmg'>mk_dmg</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_root'><span class='object_link'><a href="../top-level-namespace.html" title="Top Level Namespace (root)">root</a></span></span><span class='comma'>,</span> <span class='id identifier rubyid_out_dir'>out_dir</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="#DEFAULT_OUT_DIR-constant" title="Jamf::Composer::DEFAULT_OUT_DIR (constant)">DEFAULT_OUT_DIR</a></span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_dmg_filename'>dmg_filename</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>.dmg</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_dmg_vol'>dmg_vol</span> <span class='op'>=</span> <span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_dmg_out'>dmg_out</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../Pathname.html" title="Pathname (class)">Pathname</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_out_dir'>out_dir</span><span class='embexpr_end'>}</span><span class='tstring_content'>/</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_dmg_filename'>dmg_filename</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>if</span> <span class='id identifier rubyid_dmg_out'>dmg_out</span><span class='period'>.</span><span class='id identifier rubyid_exist?'>exist?</span>
    <span class='id identifier rubyid_mv_to'>mv_to</span> <span class='op'>=</span> <span class='id identifier rubyid_dmg_out'>dmg_out</span><span class='period'>.</span><span class='id identifier rubyid_dirname'>dirname</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_dmg_out'>dmg_out</span><span class='period'>.</span><span class='id identifier rubyid_basename'>basename</span><span class='embexpr_end'>}</span><span class='tstring_content'>.</span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="../Time.html" title="Time (class)">Time</a></span></span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_strftime'>strftime</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%Y%m%d%H%M%S</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_dmg_out'>dmg_out</span><span class='period'>.</span><span class='id identifier rubyid_rename'>rename</span> <span class='id identifier rubyid_mv_to'>mv_to</span>
  <span class='kw'>end</span> <span class='comment'># if dmg out exist
</span>
  <span class='comment'>### TODO - this may need to be sudo&#39;d to handle proper internal permissions.
</span>  <span class='id identifier rubyid_system'>system</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="#HDI_UTIL-constant" title="Jamf::Composer::HDI_UTIL (constant)">HDI_UTIL</a></span></span><span class='embexpr_end'>}</span><span class='tstring_content'> create -volname &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_dmg_vol'>dmg_vol</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; -scrub -srcfolder &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_root'><span class='object_link'><a href="../top-level-namespace.html" title="Top Level Namespace (root)">root</a></span></span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_dmg_out'>dmg_out</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>There was an error building the .dmg</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>unless</span> <span class='gvar'>$?</span><span class='period'>.</span><span class='id identifier rubyid_exitstatus'>exitstatus</span><span class='period'>.</span><span class='id identifier rubyid_zero?'>zero?</span>
  <span class='const'><span class='object_link'><a href="../Pathname.html" title="Pathname (class)">Pathname</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_dmg_out'>dmg_out</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="mk_pkg-class_method">
  
    .<strong>mk_pkg</strong>(name, version, root, opts = {})  &#x21d2; <tt><span class='object_link'><a href="../Pathname.html" title="Pathname (class)">Pathname</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Make a casper-happy .pkg out of a root folder, permissions are assumed to
be correct.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>name</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../String.html" title="String (class)">String</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the name of the .pkg. The .pkg suffix will be added if not present</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>version</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../String.html" title="String (class)">String</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the version of the .pkg, needed for building the .pkg</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>root</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../String.html" title="String (class)">String</a></span></tt>, <tt><span class='object_link'><a href="../Pathname.html" title="Pathname (class)">Pathname</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the path to the &#39;root folder&#39; representing the root file system of
the target install drive</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>opts</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Hash.html" title="Hash (class)">Hash</a></span></tt>)</span>
      
      
        <em class="default">(defaults to: <tt>{}</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>the options for building the .pkg</p>
</div>
      
    </li>
  
</ul>

  
    
    
    
    
    
    
    
    
    <p class="tag_title">Options Hash (<tt>opts</tt>):</p>
    <ul class="option">
      
        <li>
          <span class="name">:bundle_id_prefix</span>
          <span class="type">(<tt><span class='object_link'><a href="../String.html" title="String (class)">String</a></span></tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>the pkg bundle identifier prefix. If no :pkg_id is provided, one is made
using this prefix and the name provided. e.g. &#39;com.mycompany&#39;
Defaults to &#39;<span class='object_link'><a href="#PKG_BUNDLE_ID_PFX-constant" title="Jamf::Composer::PKG_BUNDLE_ID_PFX (constant)">PKG_BUNDLE_ID_PFX</a></span>&#39;. See &#39;man pkgbuild&#39; for
more info</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:out_dir</span>
          <span class="type">(<tt><span class='object_link'><a href="../String.html" title="String (class)">String</a></span></tt>, <tt><span class='object_link'><a href="../Pathname.html" title="Pathname (class)">Pathname</a></span></tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>he folder in which the .pkg will be created. Defaults to <span class='object_link'><a href="#DEFAULT_OUT_DIR-constant" title="Jamf::Composer::DEFAULT_OUT_DIR (constant)">DEFAULT_OUT_DIR</a></span></p>
</div>
          
        </li>
      
        <li>
          <span class="name">:preserve_ownership</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>If true, the owner/group of the rootpath are preserved. Default is false:
they become the pkgbuild/installer &#39;recommended&#39; (root/wheel or
root/admin)</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:signing_identity</span>
          <span class="type">(<tt><span class='object_link'><a href="../String.html" title="String (class)">String</a></span></tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>the optional name of the signing identity (certificate) to use for signing
the pkg. See `man pkgbuild` for details</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:signing_options</span>
          <span class="type">(<tt><span class='object_link'><a href="../String.html" title="String (class)">String</a></span></tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>the optional string of options to pass to pkgbuild. See `man pkgbuild` for
details</p>
</div>
          
        </li>
      
    </ul>
  

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../Pathname.html" title="Pathname (class)">Pathname</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the local path to the new .pkg</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="NoSuchItemError.html" title="Jamf::NoSuchItemError (class)">NoSuchItemError</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/jamf/composer.rb', line 95</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_mk_pkg'>mk_pkg</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_version'>version</span><span class='comma'>,</span> <span class='id identifier rubyid_root'><span class='object_link'><a href="../top-level-namespace.html" title="Top Level Namespace (root)">root</a></span></span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'><span class='object_link'><a href="NoSuchItemError.html" title="Jamf::NoSuchItemError (class)">NoSuchItemError</a></span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Missing pkgbuild tool. Please make sure you&#39;re running 10.8 or later.</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='const'><span class='object_link'><a href="#PKGBUILD-constant" title="Jamf::Composer::PKGBUILD (constant)">PKGBUILD</a></span></span><span class='period'>.</span><span class='id identifier rubyid_executable?'>executable?</span>

  <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:out_dir</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='const'><span class='object_link'><a href="#DEFAULT_OUT_DIR-constant" title="Jamf::Composer::DEFAULT_OUT_DIR (constant)">DEFAULT_OUT_DIR</a></span></span>
  <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:bundle_id_prefix</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='const'><span class='object_link'><a href="#PKG_BUNDLE_ID_PFX-constant" title="Jamf::Composer::PKG_BUNDLE_ID_PFX (constant)">PKG_BUNDLE_ID_PFX</a></span></span>

  <span class='id identifier rubyid_pkg_filename'>pkg_filename</span> <span class='op'>=</span> <span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_end_with?'>end_with?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>.pkg</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_name'>name</span> <span class='op'>:</span> <span class='id identifier rubyid_name'>name</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>.pkg</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_pkg_id'>pkg_id</span> <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:pkg_id</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_pkg_id'>pkg_id</span> <span class='op'>||=</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:bundle_id_prefix</span><span class='rbracket'>]</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>.</span><span class='tstring_end'>&#39;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_name'>name</span>
  <span class='id identifier rubyid_pkg_out'>pkg_out</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:out_dir</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>/</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pkg_filename'>pkg_filename</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_pkg_ownership'>pkg_ownership</span> <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:preserve_ownership</span><span class='rbracket'>]</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>preserve</span><span class='tstring_end'>&#39;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>recommended</span><span class='tstring_end'>&#39;</span></span>

  <span class='kw'>if</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:signing_identity</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_signing'>signing</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--sign &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:signing_identity</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_signing'>signing</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:signing_options</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:signing_options</span><span class='rbracket'>]</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_signing'>signing</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span> <span class='comment'># if opts[:signing_identity]
</span>
  <span class='comment'>### first, run &#39;analyze&#39; to get a &#39;component plist&#39; in which we can change some settings
</span>  <span class='comment'>### for any bundles in the root (bundles like .apps, frameworks, plugins, etc..)
</span>  <span class='comment'>###
</span>  <span class='comment'>### we edit the settings thus:
</span>  <span class='comment'>### BundleOverwriteAction = upgrade, totally replace any version current on disk
</span>  <span class='comment'>### BundleIsVersionChecked = false, allow us to install regardless of what version is currently installed
</span>  <span class='comment'>### BundleIsRelocatable = false,  if there&#39;s a version of this in some other location, Do Not move this one there after installation
</span>  <span class='comment'>### BundleHasStrictIdentifier = false, don&#39;t care if there&#39;s something at the install path with a different bundle id.
</span>  <span class='comment'>###
</span>  <span class='comment'>### In other words, just install the thing!
</span>  <span class='comment'>### (see &#39;man pkgbuild&#39; for more info)
</span>  <span class='comment'>###
</span>  <span class='comment'>###
</span>  <span class='id identifier rubyid_comp_plist_out'>comp_plist_out</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../Pathname.html" title="Pathname (class)">Pathname</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/tmp/</span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="#PKG_BUNDLE_ID_PFX-constant" title="Jamf::Composer::PKG_BUNDLE_ID_PFX (constant)">PKG_BUNDLE_ID_PFX</a></span></span><span class='embexpr_end'>}</span><span class='tstring_content'>-</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pkg_filename'>pkg_filename</span><span class='embexpr_end'>}</span><span class='tstring_content'>.plist</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_system'>system</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="#PKGBUILD-constant" title="Jamf::Composer::PKGBUILD (constant)">PKGBUILD</a></span></span><span class='embexpr_end'>}</span><span class='tstring_content'> --analyze --root &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_root'><span class='object_link'><a href="../top-level-namespace.html" title="Top Level Namespace (root)">root</a></span></span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_comp_plist_out'>comp_plist_out</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_comp_plist'>comp_plist</span> <span class='op'>=</span> <span class='const'>Plist</span><span class='period'>.</span><span class='id identifier rubyid_parse_xml'>parse_xml</span> <span class='id identifier rubyid_comp_plist_out'>comp_plist_out</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span>

  <span class='comment'>### if the plist is empty, there are no bundles in the pkg
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_comp_plist'>comp_plist</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='id identifier rubyid_comp_plist_arg'>comp_plist_arg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>else</span>
    <span class='comment'>### otherwise, edit the bundle dictionaries
</span>    <span class='id identifier rubyid_comp_plist'>comp_plist</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_bndl'>bndl</span><span class='op'>|</span>
      <span class='id identifier rubyid_bndl'>bndl</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ChildBundles</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_bndl'>bndl</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ChildBundles</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_bndl'>bndl</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>BundleOverwriteAction</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>upgrade</span><span class='tstring_end'>&#39;</span></span>
      <span class='id identifier rubyid_bndl'>bndl</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>BundleIsVersionChecked</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>false</span>
      <span class='id identifier rubyid_bndl'>bndl</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>BundleIsRelocatable</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>false</span>
      <span class='id identifier rubyid_bndl'>bndl</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>BundleHasStrictIdentifier</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
    <span class='comment'>### write out the edits
</span>    <span class='id identifier rubyid_comp_plist_out'>comp_plist_out</span><span class='period'>.</span><span class='id identifier rubyid_open'>open</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>w</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_f'>f</span><span class='op'>|</span> <span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_write'>write</span> <span class='id identifier rubyid_comp_plist'>comp_plist</span><span class='period'>.</span><span class='id identifier rubyid_to_plist'>to_plist</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_comp_plist_arg'>comp_plist_arg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--component-plist &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_comp_plist_out'>comp_plist_out</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'>### now build the pkg
</span>  <span class='kw'>begin</span>
    <span class='id identifier rubyid_it_built'>it_built</span> <span class='op'>=</span> <span class='id identifier rubyid_system'>system</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="#PKGBUILD-constant" title="Jamf::Composer::PKGBUILD (constant)">PKGBUILD</a></span></span><span class='embexpr_end'>}</span><span class='tstring_content'> --identifier &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pkg_id'>pkg_id</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; --version &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_version'>version</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; --ownership </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pkg_ownership'>pkg_ownership</span><span class='embexpr_end'>}</span><span class='tstring_content'> --install-location / --root &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_root'><span class='object_link'><a href="../top-level-namespace.html" title="Top Level Namespace (root)">root</a></span></span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_signing'>signing</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_comp_plist_arg'>comp_plist_arg</span><span class='embexpr_end'>}</span><span class='tstring_content'> &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pkg_out'>pkg_out</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; </span><span class='tstring_end'>&quot;</span></span>

    <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>There was an error building the .pkg</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_it_built'>it_built</span>
  <span class='kw'>ensure</span>
    <span class='id identifier rubyid_comp_plist_out'>comp_plist_out</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span> <span class='kw'>if</span> <span class='id identifier rubyid_comp_plist_out'>comp_plist_out</span><span class='period'>.</span><span class='id identifier rubyid_exist?'>exist?</span>
  <span class='kw'>end</span>

  <span class='const'><span class='object_link'><a href="../Pathname.html" title="Pathname (class)">Pathname</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_pkg_out'>pkg_out</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Fri Aug  7 11:26:25 2020 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.20 (ruby-2.3.7).
</div>

    </div>
  </body>
</html>